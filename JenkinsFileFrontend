pipeline {
    agent any

    environment {
        TARGET_SERVER = 'ubuntu@3.111.193.110'
        FRONTEND_DIR = '/home/ubuntu/KTMC_Website_Frontend'
        FRONTEND_SERVICE_NAME = 'KTMC_Website_Frontend'

        SLACK_CHANNEL = '#jenkins-cicd'
        SLACK_TOKEN_CREDENTIAL_ID = 'slack-token'
    }

    stages {
        stage('Checkout Code') {
            steps {
                checkout scm
            }
        }

       stage('Deploy Frontend to EC2') {
            steps {
                script {
                    // SCP Frontend code to EC2
                    sh """
                    scp -r ./* ${TARGET_SERVER}:${FRONTEND_DIR}/
                    """
                    // SSH into the EC2 instance for Frontend deployment
                    sh """
                    ssh ${TARGET_SERVER} << EOF                    
cd ${FRONTEND_DIR}
rm -rf node_modules package-lock.json
npm install express@4 --legacy-peer-deps
npm install --legacy-peer-deps
npm run build 
pm2 restart ${FRONTEND_SERVICE_NAME} || pm2 start server.js --name "${FRONTEND_SERVICE_NAME}"
EOF
                    """
                }
            }
        }
    }
    post {
        success {
            echo '✅ Frontend Deployed and Service Restarted Successfully!'
            slackSend(
                channel: "${env.SLACK_CHANNEL}",
                message: "✅ *Deployment Success*: `${env.JOB_NAME} #${env.BUILD_NUMBER}` completed successfully on `${env.TARGET_SERVER}`",
                tokenCredentialId: "${env.SLACK_TOKEN_CREDENTIAL_ID}",
                color: 'good'
            )
        }

        failure {
            echo '❌ Frontend Deployment Failed. Please check logs for details.'
            slackSend(
                channel: "${env.SLACK_CHANNEL}",
                message: "❌ *Deployment Failed*: `${env.JOB_NAME} #${env.BUILD_NUMBER}` failed during deployment to `${env.TARGET_SERVER}`\nCheck logs: ${env.BUILD_URL}console",
                tokenCredentialId: "${env.SLACK_TOKEN_CREDENTIAL_ID}",
                color: 'danger'
            )
        }
    }
}
